name: multimedia-docker-images

on:
  push:
    branches:
      - '*'
    paths-ignore:
      - '**/README.md'
  pull_request:
    branches:
      - '*'
  schedule:
    - cron: '30 21 */5 * *'
  workflow_dispatch:

jobs:
  multimedia-docker-images:
    name: multimedia:${{ matrix.image }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ["archlinux/base", "debian/13", "alpine/3.23", "ubuntu/24.04"]
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 5
      - name: "Build the image"
        run: CPUS=4.0 MEMORY=8GB make ${{ matrix.image }}
      - name: "Generate the Dockerfile"
        run: CPUS=4.0 MEMORY=8GB make ${{ matrix.image }}.generate
      - name: "Build the image"
        run: CPUS=4.0 MEMORY=8GB make ${{ matrix.image }}.build
      - name: "clean the image"
        run: CPUS=4.0 MEMORY=8GB make ${{ matrix.image }}.clean
#      - name: "purge the image"
#        run: CPUS=4.0 MEMORY=8GB make ${{ matrix.image }}.purge
      - name: "Pull the latest base image"
        run: CPUS=4.0 MEMORY=8GB make ${{ matrix.image }}.update
      - name: "Test the image"
        if: matrix.image == 'archlinux/base'
        run: CPUS=4.0 MEMORY=8GB make ${{ matrix.image }}.test
      - name: "Push to hub.docker.com registry, only archlinux"
        if: github.ref == 'refs/heads/main' && matrix.image == 'archlinux/base'
        run: |
            echo ${{ secrets.DOCKER_PASS }} | docker login --username ${{ secrets.DOCKER_USER }} --password-stdin
            CPUS=4.0 MEMORY=8GB make ${{ matrix.image }}.push
